apiVersion: v1
kind: ConfigMap
metadata:
  name: qbittorrent-config
  namespace: tunnelled
data:
  qBittorrent.conf: |
    [Application]
    FileLogger\Enabled=true
    FileLogger\Age=6
    FileLogger\AgeType=1
    FileLogger\Backup=true
    FileLogger\DeleteOld=true
    FileLogger\MaxSizeBytes=67108864
    FileLogger\Path=/config/qBittorrent/logs

    [BitTorrent]
    Session\Port=6881
    Session\UseRandomPort=false
    Session\Interface=
    Session\InterfaceName=
    Session\InterfaceAddress=
    Session\DefaultSavePath=/downloads/torrents/complete
    Session\TempPath=/downloads/torrents/incomplete
    Session\TempPathEnabled=true
    Session\DisableAutoTMMByDefault=false
    Session\DisableAutoTMMTriggers\CategorySavePathChanged=true
    Session\DisableAutoTMMTriggers\DefaultSavePathChanged=true
    Session\GlobalMaxSeedingMinutes=-1
    Session\QueueingSystemEnabled=true
    Session\MaxActiveDownloads=5
    Session\MaxActiveTorrents=10
    Session\MaxActiveUploads=5

    [Core]
    AutoDeleteAddedTorrentFile=Never

    [Meta]
    MigrationVersion=5

    [Network]
    Cookies=@Invalid()
    Proxy\OnlyForTorrents=false
    Proxy\PeerConnections=true
    Proxy\IP=gluetun
    Proxy\Port=8388
    Proxy\Type=SOCKS5
    Proxy\Username=
    Proxy\Password=gluetun-proxy

    [Preferences]
    # Performance Settings
    Advanced\RecheckOnCompletion=false
    Advanced\TrayIconStyle=Normal
    Advanced\useSystemIconTheme=true
    Advanced\confirmTorrentDeletion=true
    Advanced\confirmRemoveAllTags=true
    Advanced\trackerExchangeEnabled=true
    Advanced\checkAlternativeGUI=false
    Advanced\useSystemIconTheme=true
    Advanced\embedTracker=true
    Advanced\superSeedingEnabled=false
    Advanced\recheckTorrentsOnCompletion=false
    Advanced\osCache=true
    Advanced\guidedReadCache=true
    Advanced\sendBufferWatermark=500
    Advanced\sendBufferLowWatermark=10
    Advanced\sendBufferWatermarkFactor=50
    Advanced\socketBacklogSize=30
    Advanced\outgoingPortsMin=0
    Advanced\outgoingPortsMax=0
    Advanced\checkingMemUsage=32
    Advanced\diskIOType=0
    Advanced\diskIOReadMode=0
    Advanced\diskIOWriteMode=0
    Advanced\coalesceReadsWrites=true
    Advanced\pieceExtentAffinity=false
    Advanced\suggestMode=false
    Advanced\sendUploadPieceSuggestions=false
    Advanced\sendBufferWatermark=500
    Advanced\sendBufferLowWatermark=10
    Advanced\sendBufferWatermarkFactor=50
    Advanced\connectionSpeed=50
    Advanced\socketBacklogSize=30
    Advanced\anonymousMode=false
    Advanced\superSeedingEnabled=false
    Advanced\strictSuperSeeding=false
    Advanced\validateHTTPSTrackerCertificate=true
    Advanced\disableRecursiveDownload=false
    Advanced\enableEmbeddedTracker=true
    Advanced\embeddedTrackerPort=9000
    Advanced\markOfTheWeb=true
    Advanced\enableSpeedWidget=true

    # BitTorrent Protocol Settings
    Bittorrent\AddTrackers=false
    Bittorrent\DHT=true
    Bittorrent\Encryption=1
    Bittorrent\LSD=true
    Bittorrent\MaxConnections=200
    Bittorrent\MaxConnectionsPerTorrent=100
    Bittorrent\MaxRatio=-1
    Bittorrent\MaxRatioAction=0
    Bittorrent\MaxUploads=-1
    Bittorrent\MaxUploadsPerTorrent=4
    Bittorrent\PeX=true
    Bittorrent\uTP=true
    Bittorrent\uTP_rate_limited=true
    Bittorrent\MaxTrackers=8

    # Connection Settings
    Connection\PortRangeMin=6881
    Connection\PortRangeMax=6881
    Connection\UPnP=false
    Connection\ResolvePeerCountries=true
    Connection\ResolvePeerHostNames=false
    Connection\GlobalDLLimit=0
    Connection\GlobalUPLimit=0
    Connection\GlobalDLLimitAlt=0
    Connection\GlobalUPLimitAlt=0
    Connection\alt_speeds_on=false

    # Download Settings  
    Downloads\DiskWriteCacheSize=128
    Downloads\DiskWriteCacheTTL=60
    Downloads\SavePath=/downloads/torrents/complete
    Downloads\ScanDirsV2=@Invalid()
    Downloads\TempPath=/downloads/torrents/incomplete
    Downloads\TempPathEnabled=true
    Downloads\UseIncompleteExtension=false
    Downloads\FinishedTorrentExportDir=
    Downloads\PreAllocation=false
    Downloads\UseIncompleteExtension=false
    Downloads\StartInPause=false

    # RSS Settings
    RSS\AutoDownloader\DownloadRepacks=true
    RSS\AutoDownloader\SmartEpisodeFilter=s(\\d+)e(\\d+), (\\d+)x(\\d+), "(\\d{4}[.\\-]\\d{1,2}[.\\-]\\d{1,2})", "(\\d{1,2}[.\\-]\\d{1,2}[.\\-]\\d{4})"
    RSS\Session\EnableProcessing=false
    RSS\Session\MaxArticlesPerFeed=50
    RSS\Session\ProcessingEnabled=false
    RSS\Session\RefreshInterval=30

    # Scheduler (disabled by default)
    Scheduler\days=EveryDay
    Scheduler\end_time=@Variant(\\0\\0\\0\\xf\\x4J\\xa2\\0)
    Scheduler\start_time=@Variant(\\0\\0\\0\\xf\\x1\\xb7t\\0)

    # Search Settings
    Search\SearchEnabled=true

    # WebUI Settings
    WebUI\Address=*
    WebUI\AlternativeUIEnabled=false
    WebUI\AuthSubnetWhitelist=@Invalid()
    WebUI\AuthSubnetWhitelistEnabled=false
    WebUI\BanDuration=3600
    WebUI\CSRFProtection=true
    WebUI\ClickjackingProtection=true
    WebUI\CustomHTTPHeaders=
    WebUI\CustomHTTPHeadersEnabled=false
    WebUI\HTTPS\CertificatePath=
    WebUI\HTTPS\Enabled=false
    WebUI\HTTPS\KeyPath=
    WebUI\HostHeaderValidation=false
    WebUI\LocalHostAuth=false
    WebUI\MaxAuthenticationFailCount=5
    WebUI\Password_PBKDF2="@ByteArray(ARQ77eY1NUZaQsuDHbIMCA==:0WMRkYTUWVT9wVvdDtHAjU9b3b7uB8NR1Gur2hmQCvCDpm39Q+PsJRJPaCU51dEiz+dTzh8qbPsO8WkS/Qthdg==)"
    WebUI\Port=8080
    WebUI\RootFolder=
    WebUI\SecureCookie=true
    WebUI\ServerDomains=*
    WebUI\SessionTimeout=3600
    WebUI\UseUPnP=false
    WebUI\Username=admin
    WebUI\TrustedReverseProxiesList=

    # General Settings
    General\AlternatingRowColors=true
    General\CloseToTray=true
    General\CloseToTrayNotified=true
    General\CustomUIThemePath=
    General\ExitConfirm=true
    General\HideZeroComboValues=0
    General\HideZeroValues=false
    General\Locale=en
    General\MinimizeToTray=false
    General\NoSplashScreen=true
    General\PreventFromSuspendWhenDownloading=false
    General\PreventFromSuspendWhenSeeding=false
    General\StartMinimized=false
    General\SystrayEnabled=false
    General\UseCustomUITheme=false
    General\UseRandomPort=false

    # Mail Notifications (disabled)
    MailNotification\email=
    MailNotification\enabled=false
    MailNotification\password=
    MailNotification\req_auth=true
    MailNotification\req_ssl=false
    MailNotification\sender=qBittorrent_notification@example.com
    MailNotification\smtp_server=smtp.changeme.com
    MailNotification\username=

    # Dynamic DNS (disabled)
    DynDNS\DomainName=changeme.dyndns.org
    DynDNS\Enabled=false
    DynDNS\Password=
    DynDNS\Service=0
    DynDNS\Username=
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: qbittorrent-data
  namespace: tunnelled
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi
  storageClassName: longhorn
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: qbittorrent
  namespace: tunnelled
  labels:
    app: qbittorrent
spec:
  replicas: 1
  selector:
    matchLabels:
      app: qbittorrent
  template:
    metadata:
      labels:
        app: qbittorrent
    spec:
      initContainers:
        - name: wait-for-gluetun
          image: busybox:latest
          command: ["sh", "-c"]
          args:
            - |
              echo "Waiting for gluetun SOCKS5 proxy to be ready..."
              until nc -z gluetun 8388; do
                echo "Gluetun SOCKS5 proxy not ready, waiting..."
                sleep 5
              done
              echo "Gluetun SOCKS5 proxy is ready"
        - name: setup-config
          image: busybox:latest
          command: ["sh", "-c"]
          args:
            - |
              mkdir -p /config/qBittorrent
              cp /tmp/config/qBittorrent.conf /config/qBittorrent/qBittorrent.conf
              echo "Configuration file copied"
          volumeMounts:
            - name: config-data
              mountPath: /config
            - name: config-template
              mountPath: /tmp/config
      containers:
        - name: qbittorrent
          image: lscr.io/linuxserver/qbittorrent:5.1.2
          ports:
            - containerPort: 8080
            - containerPort: 8443
            - containerPort: 6881
            - containerPort: 6881
              protocol: UDP
          env:
            - name: PUID
              value: "1000"
            - name: PGID
              value: "1000"
            - name: TZ
              value: "Europe/London"
            - name: WEBUI_PORT
              value: "8080"
          volumeMounts:
            - name: config-data
              mountPath: /config
            - name: downloads
              mountPath: /downloads
          resources:
            requests:
              memory: "512Mi"
              cpu: "200m"
            limits:
              memory: "2Gi"
              cpu: "1000m"
          livenessProbe:
            httpGet:
              path: /
              port: 8080
            initialDelaySeconds: 60
            periodSeconds: 30
          readinessProbe:
            httpGet:
              path: /
              port: 8080
            initialDelaySeconds: 30
            periodSeconds: 10
      volumes:
        - name: config-data
          persistentVolumeClaim:
            claimName: qbittorrent-data
        - name: config-template
          configMap:
            name: qbittorrent-config
        - name: downloads
          persistentVolumeClaim:
            claimName: downloads-data-host
---
apiVersion: v1
kind: Service
metadata:
  name: qbittorrent
  namespace: tunnelled
  labels:
    app: qbittorrent
spec:
  selector:
    app: qbittorrent
  ports:
    - name: qbt-web-http
      port: 8080
      targetPort: 8080
    - name: qbt-web-https
      port: 8443
      targetPort: 8443
    - name: qbt-torrent-tcp
      port: 6881
      targetPort: 6881
    - name: qbt-torrent-udp
      port: 6881
      targetPort: 6881
      protocol: UDP
  type: ClusterIP