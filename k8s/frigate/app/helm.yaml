apiVersion: source.toolkit.fluxcd.io/v1
kind: HelmRepository
metadata:
  name: blakeshome
  namespace: flux-system
spec:
  interval: 24h
  url: https://blakeblackshear.github.io/blakeshome-charts/
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: frigate
  namespace: frigate
spec:
  interval: 10m0s
  timeout: 10m
  chart:
    spec:
      chart: frigate
      version: 7.8.0
      sourceRef:
        kind: HelmRepository
        name: blakeshome
        namespace: flux-system
      interval: 1h
  values:
    # Override image to latest stable release
    image:
      repository: ghcr.io/blakeblackshear/frigate
      tag: "0.16.3"
      pullPolicy: IfNotPresent

    # Upgrade strategy
    strategyType: Recreate

    # Environment variables
    env:
      TZ: "Europe/London"

    # Secrets for MQTT and RTSP credentials
    envFromSecrets:
      - frigate-secrets

    # Coral TPU configuration
    coral:
      enabled: true
      hostPath: /dev/apex_0

    # Shared memory for FFmpeg
    shmSize: 1Gi

    # Tmpfs for cache
    tmpfs:
      enabled: true
      sizeLimit: 20Gi

    # Persistence configuration
    persistence:
      config:
        enabled: true
        existingClaim: frigate-config-pvc
        ephemeralWritableConfigYaml: false
      media:
        enabled: false

    # Extra volumes for TLS certs and NFS media storage
    extraVolumes:
      - name: tls-certs
        secret:
          secretName: frigate-tls
          items:
            - key: tls.crt
              path: fullchain.pem
            - key: tls.key
              path: privkey.pem
      - name: nfs-media
        nfs:
          server: 192.168.20.40
          path: /var/nfs/shared/Frigate

    extraVolumeMounts:
      - name: tls-certs
        mountPath: /etc/letsencrypt/live/frigate/
        readOnly: true
      - name: nfs-media
        mountPath: /media/frigate

    # Privileged mode required for Coral TPU access
    securityContext:
      privileged: true

    # Resource limits matching current deployment
    resources:
      requests:
        memory: "4Gi"
        cpu: "500m"
      limits:
        memory: "4Gi"
        cpu: "2000m"

    # Health probes configuration
    probes:
      startup:
        enabled: true
        initialDelaySeconds: 60
        failureThreshold: 30
        periodSeconds: 10
        timeoutSeconds: 5
      liveness:
        enabled: true
        initialDelaySeconds: 60
        failureThreshold: 3
        timeoutSeconds: 10
        periodSeconds: 30
      readiness:
        enabled: true
        initialDelaySeconds: 30
        failureThreshold: 3
        timeoutSeconds: 5
        periodSeconds: 30

    # Service configuration - chart already exposes all required ports
    service:
      type: ClusterIP
      port: 5000

    # Disable ingress - we use Traefik IngressRoute
    ingress:
      enabled: false

    # Pod annotations for Glance dashboard
    podAnnotations:
      glance/name: "Frigate"
      glance/icon: "di:frigate-light"
      glance/url: "https://frigate.home.coredev.uk"
      glance/description: "CCTV & AI Detection"

    # Empty config since we use persistent UI-managed config from PVC
    # The existing config.yaml in the PVC will be used
    config: ""
