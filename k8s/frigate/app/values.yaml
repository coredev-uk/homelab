# Override image to latest stable release
image:
  repository: ghcr.io/blakeblackshear/frigate
  tag: "0.16.4"
  pullPolicy: IfNotPresent

# Upgrade strategy
strategyType: Recreate

# Environment variables
env:
  TZ: "Europe/London"
  OPENCV_LOG_LEVEL: "FATAL"

# Secrets for MQTT and RTSP credentials
envFromSecrets:
  - frigate-secrets

# Coral TPU configuration
coral:
  enabled: true
  hostPath: /dev/apex_0

# Shared memory for FFmpeg
shmSize: 1Gi

# Tmpfs for cache
tmpfs:
  enabled: true
  sizeLimit: 20Gi

# Persistence configuration
persistence:
  config:
    enabled: true
    existingClaim: frigate-config-pvc
    ephemeralWritableConfigYaml: false
  media:
    enabled: false

# Extra volumes for NFS media storage
extraVolumes:
  - name: nfs-media
    nfs:
      server: 192.168.20.40
      path: /var/nfs/shared/Frigate

extraVolumeMounts:
  - name: nfs-media
    mountPath: /media/frigate

# Privileged mode required for Coral TPU access
securityContext:
  privileged: true

# Resource limits matching current deployment
resources:
  requests:
    memory: "4Gi"
    cpu: "500m"
  limits:
    memory: "4Gi"
    cpu: "2000m"

# Health probes configuration
probes:
  startup:
    enabled: true
    initialDelaySeconds: 60
    failureThreshold: 30
    periodSeconds: 10
    timeoutSeconds: 5
  liveness:
    enabled: true
    initialDelaySeconds: 60
    failureThreshold: 3
    timeoutSeconds: 10
    periodSeconds: 30
  readiness:
    enabled: true
    initialDelaySeconds: 30
    failureThreshold: 3
    timeoutSeconds: 5
    periodSeconds: 30

# Service configuration - chart already exposes all required ports
service:
  type: ClusterIP
  port: 5000

# Disable ingress - we use Traefik IngressRoute
ingress:
  enabled: false

# Pod annotations for Glance dashboard
podAnnotations:
  glance/name: "Frigate"
  glance/icon: "di:frigate-light"
  glance/url: "https://frigate.coredev.uk"
  glance/description: "CCTV & AI Detection"

# Frigate configuration (see https://docs.frigate.video/configuration/index)
config: |
  mqtt:
    enabled: false

  detectors:
    coral:
      type: edgetpu
      device: pci

  telemetry:
    stats:
      network_bandwidth: true

  # Go2RTC configuration - streams named to match cameras for automatic mapping
  go2rtc:
    streams:
      front_door:
        - "ffmpeg:rtsp://{FRIGATE_RTSP_USER}:{FRIGATE_RTSP_PASSWORD}@192.168.20.5:554/stream0"
        - "ffmpeg:front_door#audio=opus"
      front_door_sub:
        - "ffmpeg:rtsp://{FRIGATE_RTSP_USER}:{FRIGATE_RTSP_PASSWORD}@192.168.20.5:554/stream1"
      back_door:
        - "ffmpeg:rtsp://{FRIGATE_RTSP_USER}:{FRIGATE_RTSP_PASSWORD}@192.168.20.6:554/11?action=play&media=video_audio_data#video=copy#audio=aac"
        - "ffmpeg:back_door#audio=opus"
      back_door_sub:
        - "ffmpeg:rtsp://{FRIGATE_RTSP_USER}:{FRIGATE_RTSP_PASSWORD}@192.168.20.6:554/12?action=play&media=video_audio_data"
      back_garden:
        - "ffmpeg:rtsp://{FRIGATE_RTSP_USER}:{FRIGATE_RTSP_PASSWORD}@192.168.20.7:554/11?action=play&media=video_audio_data#video=copy#audio=aac"
        - "ffmpeg:back_garden#audio=opus"
      back_garden_sub:
        - "ffmpeg:rtsp://{FRIGATE_RTSP_USER}:{FRIGATE_RTSP_PASSWORD}@192.168.20.7:554/12?action=play&media=video_audio_data"

  camera_groups:
    home:
      cameras:
        - front_door
        - back_door
        - back_garden
      icon: LuWebcam
      order: 0

  notifications:
    enabled: true
    email: admin@coredev.uk

  auth:
    enabled: false
    trusted_proxies:
      - 10.244.0.0/16

  proxy:
    logout_url: https://oidc.coredev.uk/api/oidc/end-session
    default_role: admin
    header_map:
      user: remote-user
      role: remote-groups

  tls:
    enabled: false

  # Global object tracking and filters
  objects:
    track:
      - person
      - car
      - dog
      - cat
    filters:
      car:
        threshold: 0.8
        min_score: 0.5

  detect:
    enabled: true

  face_recognition:
    enabled: true
    model_size: small

  # Audio disabled for detection, but still available for live view via go2rtc
  audio:
    enabled: false

  record:
    enabled: true
    retain:
      days: 7
      mode: motion
    alerts:
      retain:
        days: 30
    detections:
      retain:
        days: 30

  snapshots:
    enabled: true
    bounding_box: true
    retain:
      default: 30

  ffmpeg:
    output_args:
      record: preset-record-generic-audio-aac

  cameras:
    front_door:
      enabled: true
      webui_url: http://192.168.20.5:8080
      ffmpeg:
        inputs:
          - path: rtsp://127.0.0.1:8554/front_door
            input_args: preset-rtsp-restream-low-latency
            roles:
              - record
          - path: rtsp://127.0.0.1:8554/front_door_sub
            # input_args: preset-rtsp-restream
            input_args:
              - -rtsp_transport
              - tcp
              - -timeout
              - "5000000"
              - -analyzeduration
              - "10000000" 
              - -probesize
              - "10000000"
            roles:
              - detect
              - audio
      objects:
        track:
          - person
          - car
      detect:
        width: 720
        height: 480
        fps: 5
      zones:
        entrance:
          coordinates: 0.878,0.364,0.958,0.401,0.811,1,0.578,1
          objects:
            - person
          loitering_time: 10
          inertia: 3
        driveway:
          coordinates: 0.65,0.139,0.941,0.244,0.947,0.393,0.802,0.329,0.545,0.201
          objects:
            - car
            - person
          inertia: 3
          loitering_time: 0
      review:
        alerts:
          required_zones:
            - entrance
            - driveway

    back_door:
      enabled: true
      webui_url: http://192.168.20.6
      ffmpeg:
        inputs:
          - path: rtsp://127.0.0.1:8554/back_door
            input_args: preset-rtsp-restream
            roles:
              - record
          - path: rtsp://127.0.0.1:8554/back_door_sub
            input_args: preset-rtsp-restream
            roles:
              - detect
              - audio
      onvif:
        host: 192.168.20.6
        port: 8080
        user: '{FRIGATE_RTSP_USER}'
        password: '{FRIGATE_RTSP_PASSWORD}'
      objects:
        track:
          - person
          - car
      zones:
        back_entrance:
          coordinates: 0.297,0.538,0.344,0.549,0.44,0.584,0.433,0.654,0.411,0.698,0.373,0.761,0.325,0.82,0.242,0.826,0.189,0.814,0.184,0.74,0.194,0.655,0.203,0.621,0.216,0.535
          objects:
            - person
        back_driveway:
          coordinates: 0.3,0.476,0.642,0.43,0.566,0.339,0.531,0.296,0.521,0.281,0.493,0.261,0.467,0.257,0.435,0.258,0.405,0.241,0.404,0.315,0.367,0.283,0.312,0.265,0.289,0.27,0.288,0.325
          objects:
            - car
            - person
          inertia: 3
          loitering_time: 0
      review:
        alerts:
          required_zones:
            - back_entrance
            - back_driveway
        detections:
          required_zones:
            - back_entrance
            - back_driveway

    back_garden:
      enabled: true
      webui_url: http://192.168.20.7
      ffmpeg:
        inputs:
          - path: rtsp://127.0.0.1:8554/back_garden
            input_args: preset-rtsp-restream
            roles:
              - record
          - path: rtsp://127.0.0.1:8554/back_garden_sub
            input_args: preset-rtsp-restream
            roles:
              - detect
              - audio
      onvif:
        host: 192.168.20.7
        port: 8080
        user: '{FRIGATE_RTSP_USER}'
        password: '{FRIGATE_RTSP_PASSWORD}'
      objects:
        track:
          - person
          - dog
          - cat
      zones:
        garden_main:
          coordinates: 0.001,0.997,0,0.585,0.537,0.334,0.83,0.379,0.999,0.482,0.948,0.981
          loitering_time: 0
        garden_patio:
          coordinates: 0.642,0.295,0.852,0.332,0.834,0.382,0.597,0.343
          loitering_time: 0

  version: 0.16-0
