# Alloy configuration for Kubernetes log collection
# Deploys as DaemonSet to collect logs from all nodes

alloy:
  # Alloy configuration in River format
  configMap:
    content: |-
      // Discover Kubernetes pods for log collection
      discovery.kubernetes "pods" {
        role = "pod"
      }

      // Relabel discovered pods to extract metadata
      discovery.relabel "pods" {
        targets = discovery.kubernetes.pods.targets

        // Keep only running pods
        rule {
          source_labels = ["__meta_kubernetes_pod_phase"]
          action        = "keep"
          regex         = "Running"
        }

        // Set the log path for each container
        rule {
          source_labels = ["__meta_kubernetes_pod_uid", "__meta_kubernetes_pod_container_name"]
          target_label  = "__path__"
          separator     = "/"
          replacement   = "/var/log/pods/*$1/*.log"
        }

        // Add pod metadata as labels
        rule {
          source_labels = ["__meta_kubernetes_namespace"]
          target_label  = "namespace"
        }

        rule {
          source_labels = ["__meta_kubernetes_pod_name"]
          target_label  = "pod"
        }

        rule {
          source_labels = ["__meta_kubernetes_pod_container_name"]
          target_label  = "container"
        }

        rule {
          source_labels = ["__meta_kubernetes_pod_node_name"]
          target_label  = "node"
        }

        // Add job label
        rule {
          source_labels = ["__meta_kubernetes_namespace", "__meta_kubernetes_pod_name"]
          separator     = "/"
          target_label  = "job"
        }
      }

      // Scrape logs from the discovered pods
      loki.source.kubernetes "pods" {
        targets    = discovery.relabel.pods.output
        forward_to = [loki.write.default.receiver]
      }

      // Send logs to Loki
      loki.write "default" {
        endpoint {
          url = "http://monitoring-loki-gateway.monitoring.svc.cluster.local/loki/api/v1/push"
        }
      }

  # Mount host paths for log collection
  mounts:
    varlog: true

  # Resource limits for homelab
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 512Mi

# Deploy as DaemonSet (one pod per node)
controller:
  type: daemonset

# RBAC for Kubernetes discovery
rbac:
  create: true

# Service account
serviceAccount:
  create: true
