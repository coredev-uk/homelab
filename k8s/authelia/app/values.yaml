# Pod configuration
pod:
  kind: Deployment
  replicas: 1
  
  resources:
    requests:
      memory: "64Mi"
      cpu: "50m"
    limits:
      memory: "128Mi"
      cpu: "200m"
  
  env:
    - name: TZ
      value: "Europe/London"
    - name: X_AUTHELIA_CONFIG_FILTERS
      value: "template"

# Persistence for SQLite database
persistence:
  enabled: true
  storageClass: longhorn
  size: 1Gi
  accessModes:
    - ReadWriteOnce

# Service configuration
service:
  annotations:
    glance/name: "Authelia"
    glance/icon: "mdi:shield-account"
    glance/url: "https://auth.home.coredev.uk"
    glance/description: "Authentication & SSO"

# Ingress configuration
ingress:
  enabled: true
  className: traefik
  annotations:
    traefik.ingress.kubernetes.io/router.entrypoints: web,websecure
    traefik.ingress.kubernetes.io/router.tls: "true"
    traefik.ingress.kubernetes.io/redirect-to-https: "true"
    cert-manager.io/cluster-issuer: letsencrypt-prod
  subdomain: auth
  domain: home.coredev.uk
  tls:
    enabled: true
    secret: authelia-tls

# Authelia configuration
configMap:
  theme: auto
  
  server:
    address: tcp://0.0.0.0:9091/
    
  log:
    level: info
    format: text
    keep_stdout: true
  
  totp:
    issuer: home.coredev.uk
    period: 30
    skew: 1
  
  # Authentication backend - LDAP (lldap)
  authentication_backend:
    password_reset:
      disable: false
    refresh_interval: 5m
    ldap:
      enabled: true
      implementation: lldap
      address: ldap://lldap:3890
      timeout: 5s
      start_tls: false
      base_dn: dc=home,dc=coredev,dc=uk
      additional_users_dn: ou=people
      users_filter: '(&(|({username_attribute}={input})({mail_attribute}={input}))(objectClass=person))'
      additional_groups_dn: ou=groups
      groups_filter: '(&(member={dn})(objectClass=groupOfNames))'
      user: uid=admin,ou=people,dc=home,dc=coredev,dc=uk
      password:
        secret_name: authelia-secrets
        path: ldap-password
      attributes:
        username: uid
        display_name: cn
        mail: mail
        member_of: memberOf
        group_name: cn
  
  # Access control
  access_control:
    default_policy: deny
    rules:
      - domain: auth.home.coredev.uk
        policy: bypass
      - domain: '*.home.coredev.uk'
        policy: one_factor
  
  # Session configuration with Redis
  session:
    cookies:
      - domain: home.coredev.uk
        authelia_url: https://auth.home.coredev.uk
        default_redirection_url: https://home.coredev.uk
        name: authelia_session
        same_site: lax
        expiration: 1h
        inactivity: 5m
        remember_me: 1M
    redis:
      enabled: true
      host: redis
      port: 6379
    secret:
      secret_name: authelia-secrets
      path: session-secret
  
  # Rate limiting
  regulation:
    max_retries: 3
    find_time: 2m
    ban_time: 5m
  
  # Storage backend - SQLite
  storage:
    local:
      enabled: true
      path: /config/db.sqlite3
    encryption_key:
      secret_name: authelia-secrets
      path: storage-encryption-key
  
  # Notifier - filesystem
  notifier:
    disable_startup_check: false
    filesystem:
      enabled: true
      filename: /config/notification.txt
  
  # Identity validation
  identity_validation:
    reset_password:
      jwt_secret:
        secret_name: authelia-secrets
        path: jwt-secret
  
  # OIDC Identity Providers
  identity_providers:
    oidc:
      enabled: true
      hmac_secret:
        secret_name: authelia-secrets
        path: oidc-hmac-secret
      jwks:
        - key:
            secret_name: authelia-secrets
            path: oidc-private-key
      lifespans:
        access_token: 1h
        authorize_code: 1m
        id_token: 1h
        refresh_token: 90m
      enable_client_debug_messages: false
      enforce_pkce: public_clients_only
      cors:
        endpoints:
          - authorization
          - token
          - revocation
          - introspection
        allowed_origins_from_client_redirect_uris: true
      
      # OIDC Clients
      clients:
        # Grafana client
        - client_id: grafana
          client_name: Grafana Monitoring
          client_secret:
            secret_name: authelia-secrets
            path: grafana-client-secret
          public: false
          authorization_policy: one_factor
          redirect_uris:
            - https://grafana.home.coredev.uk/login/generic_oauth
          scopes:
            - openid
            - profile
            - email
            - groups
          grant_types:
            - authorization_code
          response_types:
            - code
