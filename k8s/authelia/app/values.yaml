# Pod configuration
pod:
  kind: Deployment
  replicas: 1
  
  resources:
    requests:
      memory: "64Mi"
      cpu: "50m"
    limits:
      memory: "128Mi"
      cpu: "200m"
  
  env:
    - name: TZ
      value: "Europe/London"
    - name: X_AUTHELIA_CONFIG_FILTERS
      value: "template"

# Persistence for SQLite database
persistence:
  enabled: true
  storageClass: longhorn
  size: 1Gi
  accessModes:
    - ReadWriteOnce

# Service configuration
service:
  annotations:
    glance/name: "Authelia"
    glance/icon: "mdi:shield-account"
    glance/url: "https://auth.home.coredev.uk"
    glance/description: "Authentication & SSO"
    traefik.ingress.kubernetes.io/service.serversscheme: http
    traefik.ingress.kubernetes.io/service.loadbalancer.strategy: wrr

# Ingress configuration - Using Traefik IngressRoute CRD
ingress:
  enabled: true
  className: traefik
  certManager: true
  traefikCRD:
    enabled: true
    disableIngressRoute: false
    entryPoints:
      - websecure
    strategy: wrr  # Use wrr instead of deprecated RoundRobin
  tls:
    enabled: true
    secret: authelia-tls

# Secret configuration - mount external secrets
secret:
  additionalSecrets:
    authelia-secrets: {}

# Authelia configuration (must be under configMap for helm chart 0.10.x)
configMap:
  theme: auto
  
  log:
    level: info
    format: text
  
  totp:
    issuer: home.coredev.uk
    period: 30
    skew: 1
  
  # Authentication backend - LDAP (lldap)
  authentication_backend:
    password_reset:
      disable: false
    refresh_interval: 5m
    ldap:
      enabled: true
      implementation: lldap
      address: ldap://authelia-lldap:3890
      timeout: 5s
      start_tls: false
      base_dn: dc=home,dc=coredev,dc=uk
      additional_users_dn: ou=people
      users_filter: '(&(|({username_attribute}={input})({mail_attribute}={input}))(objectClass=person))'
      additional_groups_dn: ou=groups
      groups_filter: '(&(member={dn})(objectClass=groupOfNames))'
      user: uid=admin,ou=people,dc=home,dc=coredev,dc=uk
      password:
        secret_name: authelia-secrets
        path: lldap-admin-password
      attributes:
        username: uid
        display_name: cn
        mail: mail
        member_of: memberOf
        group_name: cn
  
  # Access control
  access_control:
    default_policy: deny
    rules:
      # Authelia itself - no authentication required
      - domain: auth.home.coredev.uk
        policy: bypass
      
      # API bypass rules (must be before group-specific rules)
      - domain: homebridge.home.coredev.uk
        resources:
          - '^/api/.*$'
          - '^/socket.io/.*$'
        policy: bypass
      - domain: qbittorrent.home.coredev.uk
        resources:
          - '^/api/.*$'
        policy: bypass
      
      # Media admin group - arr stack and related tools
      - domain:
          - radarr.home.coredev.uk
          - sonarr.home.coredev.uk
          - bazarr.home.coredev.uk
          - prowlarr.home.coredev.uk
          - sabnzbd.home.coredev.uk
          - qbittorrent.home.coredev.uk
          - huntarr.home.coredev.uk
          - cleanuparr.home.coredev.uk
          - notifiarr.home.coredev.uk
        policy: one_factor
        subject:
          - "group:media_admin"
      
      # Cluster admin group - infrastructure services
      - domain:
          - traefik.home.coredev.uk
          - longhorn.home.coredev.uk
          - prometheus.home.coredev.uk
          - pihole.home.coredev.uk
          - homebridge.home.coredev.uk
        policy: one_factor
        subject:
          - "group:cluster_admin"
      
      # Glance dashboard - accessible to all authenticated users
      - domain: glance.home.coredev.uk
        policy: one_factor
  
  # Session configuration with Redis
  session:
    cookies:
      - subdomain: auth
        domain: home.coredev.uk
        authelia_url: https://auth.home.coredev.uk
        default_redirection_url: https://glance.home.coredev.uk
        name: authelia_session
        same_site: lax
        expiration: 1h
        inactivity: 5m
        remember_me: 1M
    redis:
      host: redis
      port: 6379
  
  # Rate limiting
  regulation:
    max_retries: 3
    find_time: 2m
    ban_time: 5m
  
  # Storage backend - SQLite
  storage:
    local:
      enabled: true
      path: /config/db.sqlite3
    encryption_key:
      secret_name: authelia-secrets
      path: storage-encryption-key
  
  # Notifier - filesystem
  notifier:
    disable_startup_check: false
    filesystem:
      enabled: true
      filename: /config/notification.txt
  
  # Identity validation
  identity_validation:
    reset_password:
      secret:
        secret_name: authelia-secrets
        path: jwt-secret
  
  # OIDC Identity Providers
  identity_providers:
    oidc:
      enabled: true
      hmac_secret:
        secret_name: authelia-secrets
        path: oidc-hmac-secret
      jwks:
        - key:
            path: /secrets/authelia-secrets/oidc-private-key
      lifespans:
        access_token: 1h
        authorize_code: 1m
        id_token: 1h
        refresh_token: 90m
      enable_client_debug_messages: false
      enforce_pkce: public_clients_only
      cors:
        endpoints:
          - authorization
          - token
          - revocation
          - introspection
        allowed_origins_from_client_redirect_uris: true
      
      # Claims policies for clients that don't properly support OIDC
      claims_policies:
        grafana:
          id_token:
            - email
            - name
            - groups
            - preferred_username
      
      # Authorization policies for group-based access
      authorization_policies:
        media_admin:
          default_policy: deny
          rules:
            - policy: one_factor
              subject:
                - group:media_admin
      
      # OIDC Clients
      clients:
        # Grafana client
        - client_id: grafana
          client_name: Grafana Monitoring
          claims_policy: grafana
          client_secret:
            path: /secrets/authelia-secrets/grafana-client-secret
          public: false
          authorization_policy: one_factor
          redirect_uris:
            - https://grafana.home.coredev.uk/login/generic_oauth
          scopes:
            - openid
            - profile
            - email
            - groups
          userinfo_signed_response_alg: none
          token_endpoint_auth_method: client_secret_basic
          grant_types:
            - authorization_code
          response_types:
            - code
        
        # Qui qBittorrent UI client
        - client_id: qui
          client_name: Qui qBittorrent UI
          client_secret:
            path: /secrets/authelia-secrets/qui-client-secret
          public: false
          authorization_policy: one_factor
          redirect_uris:
            - https://qui.home.coredev.uk/api/auth/oidc/callback
          scopes:
            - openid
            - profile
            - email
          userinfo_signed_response_alg: none
          token_endpoint_auth_method: client_secret_post
          grant_types:
            - authorization_code
          response_types:
            - code

        # Jellyfin
        - client_id: jellyfin
          client_name: Jellyfin
          client_secret:
            path: /secrets/authelia-secrets/jellyfin-client-secret
          public: false
          authorization_policy: one_factor
          redirect_uris:
            - https://jellyfin.home.coredev.uk/sso/SAML/post/authelia
          scopes:
            - openid
            - profile
            - groups
          userinfo_signed_response_alg: none
          token_endpoint_auth_method: client_secret_post
          grant_types:
            - authorization_code
          response_types:
            - code
