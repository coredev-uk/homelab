apiVersion: apps/v1
kind: Deployment
metadata:
  name: tailscale-subnet-router
  namespace: tailscale-router
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: tailscale-subnet-router
  template:
    metadata:
      labels:
        app: tailscale-subnet-router
    spec:
      serviceAccountName: tailscale-router
      initContainers:
        - name: sysctler
          image: busybox:latest
          command:
            - sh
            - -c
            - |
              sysctl -w net.ipv4.ip_forward=1
              sysctl -w net.ipv6.conf.all.forwarding=1
          securityContext:
            privileged: true
        - name: nftables-setup
          image: alpine:latest
          command:
            - sh
            - -c
            - |
              apk add --no-cache nftables
              nft add table ip nat 2>/dev/null || true
              nft add chain ip nat ts-postrouting { type nat hook postrouting priority 100 \; } 2>/dev/null || true
              nft add rule ip nat ts-postrouting meta mark and 0x00ff0000 == 0x00040000 masquerade 2>/dev/null || true
              echo "nftables masquerade rule added"
          securityContext:
            privileged: true
      containers:
        - name: tailscale
          image: tailscale/tailscale:latest
          imagePullPolicy: IfNotPresent
          env:
            - name: TS_AUTHKEY
              valueFrom:
                secretKeyRef:
                  name: tailscale-auth
                  key: authkey
            - name: TS_EXTRA_ARGS
              value: "--login-server=http://headscale.headscale.svc.cluster.local:8080 --advertise-routes=10.244.0.0/16,10.96.0.0/12,192.168.20.0/24 --advertise-tags=tag:subnet-router --accept-dns=false"
            - name: TS_STATE_DIR
              value: "/var/lib/tailscale"
            - name: TS_USERSPACE
              value: "false"
            - name: TS_AUTH_ONCE
              value: "true"
            - name: TS_DEBUG_FIREWALL_MODE
              value: "nftables"
          securityContext:
            privileged: true
          volumeMounts:
            - name: tailscale-state
              mountPath: /var/lib/tailscale
            - name: dev-net-tun
              mountPath: /dev/net/tun
            - name: lib-modules
              mountPath: /lib/modules
              readOnly: true
          resources:
            requests:
              memory: "64Mi"
              cpu: "50m"
            limits:
              memory: "256Mi"
              cpu: "500m"
      volumes:
        - name: tailscale-state
          emptyDir: {}
        - name: dev-net-tun
          hostPath:
            path: /dev/net/tun
            type: CharDevice
        - name: lib-modules
          hostPath:
            path: /lib/modules
            type: Directory
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: tailscale-router
  namespace: tailscale-router
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: tailscale-router
  namespace: tailscale-router
rules:
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["create", "get", "update", "patch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: tailscale-router
  namespace: tailscale-router
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: tailscale-router
subjects:
  - kind: ServiceAccount
    name: tailscale-router
    namespace: tailscale-router
