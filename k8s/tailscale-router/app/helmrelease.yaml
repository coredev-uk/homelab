# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s-labs/helm-charts/main/charts/other/app-template/schemas/helmrelease-helm-v2.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: tailscale-router
  namespace: tailscale-router
spec:
  interval: 30m
  chartRef:
    kind: OCIRepository
    name: app-template
    namespace: tailscale-router
  values:
    controllers:
      main:
        strategy: Recreate
        pod:
          serviceAccountName: tailscale-router
        initContainers:
          sysctler:
            image:
              repository: busybox
              tag: latest@sha256:b3255e7dfbcd10cb367af0d409747d511aeb66dfac98cf30e97e87e4207dd76f
            command:
              - sh
              - -c
              - |
                sysctl -w net.ipv4.ip_forward=1
                sysctl -w net.ipv6.conf.all.forwarding=1
            securityContext:
              privileged: true
          nftables-setup:
            image:
              repository: alpine
              tag: latest@sha256:25109184c71bdad752c8312a8623239686a9a2071e8825f20acb8f2198c3f659
            command:
              - sh
              - -c
              - |
                apk add --no-cache nftables
                nft add table ip nat 2>/dev/null || true
                nft add chain ip nat ts-postrouting { type nat hook postrouting priority 100 \; } 2>/dev/null || true
                nft add rule ip nat ts-postrouting meta mark and 0x00ff0000 == 0x00040000 masquerade 2>/dev/null || true
                echo "nftables masquerade rule added"
            securityContext:
              privileged: true
            dependsOn:
              - sysctler
        containers:
          main:
            image:
              repository: tailscale/tailscale
              tag: latest@sha256:95e528798bebe75f39b10e74e7051cf51188ee615934f232ba7ad06a3390ffa1
            env:
              TS_AUTHKEY:
                valueFrom:
                  secretKeyRef:
                    name: tailscale-auth
                    key: authkey
              TS_EXTRA_ARGS: "--login-server=http://headscale.headscale.svc.cluster.local:8080 --advertise-routes=10.244.0.0/16,10.96.0.0/12,192.168.20.0/24 --advertise-tags=tag:subnet-router --accept-dns=false --snat-subnet-routes=true"
              TS_STATE_DIR: /var/lib/tailscale
              TS_USERSPACE: "false"
              TS_AUTH_ONCE: "true"
              TS_DEBUG_FIREWALL_MODE: nftables
            securityContext:
              privileged: true
            resources:
              requests:
                memory: 64Mi
                cpu: 50m
              limits:
                memory: 256Mi
                cpu: 500m

    service:
      main:
        enabled: false

    persistence:
      tailscale-state:
        type: emptyDir
        advancedMounts:
          main:
            main:
              - path: /var/lib/tailscale
      dev-net-tun:
        type: hostPath
        hostPath: /dev/net/tun
        hostPathType: CharDevice
        advancedMounts:
          main:
            main:
              - path: /dev/net/tun
      lib-modules:
        type: hostPath
        hostPath: /lib/modules
        hostPathType: Directory
        advancedMounts:
          main:
            main:
              - path: /lib/modules
                readOnly: true
