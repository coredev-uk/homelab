apiVersion: apps/v1
kind: Deployment
metadata:
  name: jellyfin
  namespace: jellyfin
  labels:
    app.kubernetes.io/name: jellyfin
    app.kubernetes.io/instance: jellyfin
    app.kubernetes.io/component: media-server
    app.kubernetes.io/part-of: media-stack
  annotations:
    glance/name: "Jellyfin"
    glance/icon: "di:jellyfin"
    glance/url: "https://jellyfin.home.coredev.uk"
    glance/description: "Media Server"
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app.kubernetes.io/name: jellyfin
      app.kubernetes.io/instance: jellyfin
  template:
    metadata:
      labels:
        app.kubernetes.io/name: jellyfin
        app.kubernetes.io/instance: jellyfin
        app.kubernetes.io/component: media-server
        app.kubernetes.io/part-of: media-stack
    spec:
      securityContext:
        fsGroup: 988
        fsGroupChangePolicy: "OnRootMismatch"
      containers:
        - name: jellyfin
          image: jellyfin/jellyfin:10.11.6
          ports:
            - containerPort: 8096
              protocol: TCP
            - containerPort: 8920
              protocol: TCP
            - containerPort: 7359
              protocol: UDP
            - containerPort: 1900
              protocol: UDP
          securityContext:
            runAsUser: 1000
            runAsGroup: 988
            capabilities:
              add:
                - SYS_ADMIN # Required for Intel VA-API access
          # livenessProbe:
          #   httpGet:
          #     path: /health
          #     port: 8096
          #   initialDelaySeconds: 60
          #   periodSeconds: 30
          #   timeoutSeconds: 10
          # readinessProbe:
          #   httpGet:
          #     path: /health
          #     port: 8096
          #   initialDelaySeconds: 30
          #   periodSeconds: 30
          #   timeoutSeconds: 10
          #   failureThreshold: 5
          volumeMounts:
            - name: config
              mountPath: /config
            - name: cache
              mountPath: /cache
            - name: data
              mountPath: /data
            - name: render-device
              mountPath: /dev/dri/renderD128
          resources:
            requests:
              memory: "4Gi"
              cpu: "500m"
              gpu.intel.com/i915: 1
            limits:
              memory: "4Gi"
              cpu: "6000m"
              gpu.intel.com/i915: 1
      # tolerations:
      #   - key: intel-gpu
      #     operator: Exists
      #     effect: NoSchedule
      volumes:
        - name: config
          persistentVolumeClaim:
            claimName: jellyfin-config-pvc
        - name: cache
          persistentVolumeClaim:
            claimName: jellyfin-cache-pvc
        - name: data
          nfs:
            server: 192.168.20.40
            path: /var/nfs/shared/Homelab
        - name: render-device
          hostPath:
            path: /dev/dri/renderD128
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: jellyfin-config-pvc
  namespace: jellyfin
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
  storageClassName: longhorn
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: jellyfin-cache-pvc
  namespace: jellyfin
  labels:
    recurring-job.longhorn.io/source: enabled
    recurring-job-group.longhorn.io/default: disabled
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 50Gi
  storageClassName: longhorn
---
apiVersion: v1
kind: Service
metadata:
  name: jellyfin
  namespace: jellyfin
spec:
  selector:
    app.kubernetes.io/name: jellyfin
    app.kubernetes.io/instance: jellyfin
  ports:
    - name: http
      port: 8096
      targetPort: 8096
      protocol: TCP
    - name: https
      port: 8920
      targetPort: 8920
      protocol: TCP
    - name: client-discovery
      port: 7359
      targetPort: 7359
      protocol: UDP
    - name: dlna-discovery
      port: 1900
      targetPort: 1900
      protocol: UDP
