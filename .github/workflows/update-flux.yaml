name: Update Flux

on:
  workflow_dispatch:
  schedule:
    # Run weekly on Monday at 09:00 UTC
    - cron: "0 9 * * 1"

permissions:
  contents: write
  pull-requests: write

jobs:
  update-flux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Flux CLI
        uses: fluxcd/flux2/action@main
        with:
          version: 'latest'
      
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Check for Flux updates
        id: update
        run: |
          # Get current Flux version from gotk-components.yaml
          CURRENT_VERSION=$(grep 'app.kubernetes.io/version:' flux/flux-system/gotk-components.yaml | head -1 | awk '{print $2}' | tr -d 'v')
          
          # Get latest Flux version
          LATEST_VERSION=$(flux version --client -o json | jq -r .flux | tr -d 'v')
          
          echo "current_version=v$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "latest_version=v$LATEST_VERSION" >> $GITHUB_OUTPUT
          
          if [ "$CURRENT_VERSION" != "$LATEST_VERSION" ]; then
            echo "update_available=true" >> $GITHUB_OUTPUT
            echo "Flux update available: v$CURRENT_VERSION -> v$LATEST_VERSION"
          else
            echo "update_available=false" >> $GITHUB_OUTPUT
            echo "Flux is up to date: v$CURRENT_VERSION"
          fi

      - name: Update Flux components
        if: steps.update.outputs.update_available == 'true'
        run: |
          flux install --export > ./flux/flux-system/gotk-components.yaml
          
          echo "Updated Flux components to ${{ steps.update.outputs.latest_version }}"

      - name: Create Pull Request
        if: steps.update.outputs.update_available == 'true'
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: update-flux-${{ steps.update.outputs.latest_version }}
          commit-message: "chore(flux): update to ${{ steps.update.outputs.latest_version }}"
          title: "Update Flux to ${{ steps.update.outputs.latest_version }}"
          body: |
            ## Flux Update

            This PR updates Flux from `${{ steps.update.outputs.current_version }}` to `${{ steps.update.outputs.latest_version }}`.

            ### Changes
            - Updated `flux/flux-system/gotk-components.yaml` with latest Flux components

            ### Release Notes
            See the [Flux ${{ steps.update.outputs.latest_version }} release notes](https://github.com/fluxcd/flux2/releases/tag/${{ steps.update.outputs.latest_version }}) for details.

            ---
            *This PR was automatically generated by the Update Flux workflow.*
          labels: |
            dependencies
            flux
          draft: false
          delete-branch: true

      - name: No updates available
        if: steps.update.outputs.update_available == 'false'
        run: |
          echo "Flux is already at the latest version (${{ steps.update.outputs.current_version }})"
